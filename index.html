<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mapa com Pontos de Interesse</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.css" />
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button id="addBtn">Adicionar ponto</button>
    <div id="map"></div>

    <!-- Modal de confirmação da localização -->
    <div id="locate-modal-backdrop" class="modal-backdrop hidden">
        <div id="locate-modal" class="modal-content">
            <h4>Confirmar Localização</h4>
            <p>A localização em computadores (sem GPS) pode ser imprecisa.</p>
            <p>Para parar de seguir a localização, clique no botão novamente.</p>
            <div class="modal-actions">
                <button id="modal-confirm-locate" class="modal-btn modal-btn-confirm">Ativar</button>
                <button id="modal-cancel-locate" class="modal-btn modal-btn-cancel">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Scripts Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>
    <script src="https://unpkg.com/leaflet-search@3.0.9/dist/leaflet-search.min.js"></script>

    <script>
        let adding = false;
        let markerIdCounter = 0;
        const STORAGE_KEY = 'mapPoints';
        const markers = {};
        const searchableMarkers = L.layerGroup();

        // Ícones personalizados
        const icons = {
            red: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
            green: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
            blue: L.icon({
                iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            }),
            yellow: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
                shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            })
        };

        const categories = {
            ocorrencia: { name: 'Ocorrência', icon: icons.red },
            vigilancia: { name: 'Vigilância', icon: icons.green },
            apreensao: { name: 'Apreensão', icon: icons.blue },
            outro: { name: 'Outro', icon: icons.yellow }
        };

        // Inicialização do mapa
        const map = L.map('map', {
            minZoom: 3,
            maxBounds: L.latLngBounds(L.latLng(-90, -180), L.latLng(90, 180)),
            maxBoundsViscosity: 1.0
        }).setView([-14.235, -51.9253], 6);

        searchableMarkers.addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors, © CartoDB',
            noWrap: true
        }).addTo(map);

        // Geocoder (pesquisa de endereço)
        L.Control.geocoder({
            placeholder: 'Pesquisar endereço...',
            defaultMarkGeocode: false,
            collapsed: false,
            position: 'topright'
        }).on('markgeocode', e => {
            map.fitBounds(e.geocode.bbox);
        }).addTo(map);

        // Localização do usuário
        const locateControl = L.control.locate({
            flyTo: true,
            keepCurrentZoomLevel: true,
            locateOptions: { enableHighAccuracy: true },
            markerClass: L.CircleMarker,
            markerStyle: { color: '#136AEC', fillColor: '#2A93EE', fillOpacity: 0.7, weight: 2, radius: 5 },
            circleStyle: { color: '#136AEC', fillOpacity: 0.15, weight: 0 }
        });

        const CustomLocateButton = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function () {
                const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                const button = L.DomUtil.create('a', 'custom-locate-button', container);
                button.href = '#';
                button.title = 'Mostrar localização';
                L.DomEvent.disableClickPropagation(button);
                L.DomEvent.on(button, 'click', e => {
                    e.preventDefault();
                    if (locateControl._active) locateControl.stop();
                    else document.getElementById('locate-modal-backdrop').classList.remove('hidden');
                });
                return container;
            }
        });
        map.addControl(new CustomLocateButton());

        document.getElementById('modal-cancel-locate').onclick = () => {
            document.getElementById('locate-modal-backdrop').classList.add('hidden');
        };
        document.getElementById('modal-confirm-locate').onclick = () => {
            document.getElementById('locate-modal-backdrop').classList.add('hidden');
            locateControl.start();
        };

        // Controle de pesquisa de pontos
        const searchControl = new L.Control.Search({
            layer: searchableMarkers,
            propertyName: 'searchableText',
            marker: false,
            position: 'topright',
            collapsed: false,
            textPlaceholder: 'Pesquisar ponto...',
            moveToLocation: (latlng, title, map) => {
                map.setView(latlng, 15);
                searchableMarkers.eachLayer(layer => {
                    if (layer.options.title === title) layer.openPopup();
                });
            }
        });
        map.addControl(searchControl);

        // Funções auxiliares
        function getPopupContent(id, name, description, categoryKey) {
            const cat = categories[categoryKey] || categories.outro;
            return `
                <small class="popup-category">${cat.name}</small>
                <b>${name}</b><br>${description}
                <div class="popup-actions">
                    <button class="popup-edit-btn" data-id="${id}">Editar</button>
                    <button class="popup-delete-btn" data-id="${id}">Apagar</button>
                </div>`;
        }

        function getFormHTML(data = {}) {
            const { id, name = '', description = '', category = 'outro' } = data;
            const categoryOptions = Object.keys(categories)
                .map(k => `<option value="${k}" ${k === category ? 'selected' : ''}>${categories[k].name}</option>`)
                .join('');
            return `
                <form id="${id ? 'editPointForm' : 'pointForm'}" ${id ? `data-id="${id}"` : ''}>
                    <label>Nome</label>
                    <input type="text" name="name" value="${name}" required>
                    <label>Descrição</label>
                    <textarea name="description">${description}</textarea>
                    <label>Categoria</label>
                    <select name="category">${categoryOptions}</select>
                    <div class="form-actions">
                        <button type="submit">Salvar</button>
                        <button type="button" class="cancelBtn">Cancelar</button>
                    </div>
                </form>`;
        }

        function saveMarkers() {
            const data = Object.values(markers).map(m => ({
                id: m.id, name: m.name, description: m.description,
                lat: m.lat, lng: m.lng, category: m.category
            }));
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadMarkers() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            const parsed = JSON.parse(saved);
            let maxId = 0;
            parsed.forEach(d => {
                const icon = (categories[d.category] || categories.outro).icon;
                const popup = getPopupContent(d.id, d.name, d.description, d.category);
                const marker = L.marker([d.lat, d.lng], {
                    icon, title: d.name, searchableText: `${d.name} ${d.description}`
                }).bindPopup(popup).bindTooltip(d.name);
                searchableMarkers.addLayer(marker);
                markers[d.id] = { ...d, marker };
                maxId = Math.max(maxId, d.id);
            });
            markerIdCounter = maxId + 1;
        }

        // Adicionar novo ponto
        const addBtn = document.getElementById('addBtn');
        addBtn.onclick = () => {
            adding = !adding;
            addBtn.textContent = adding ? 'Cancelar' : 'Adicionar ponto';
            map.getContainer().style.cursor = adding ? 'crosshair' : '';
        };

        map.on('click', e => {
            if (!adding) return;
            adding = false;
            addBtn.textContent = 'Adicionar ponto';
            map.getContainer().style.cursor = '';
            const popup = L.popup().setLatLng(e.latlng).setContent(getFormHTML()).openOn(map);
            setTimeout(() => {
                const form = document.getElementById('pointForm');
                form.addEventListener('submit', ev => {
                    ev.preventDefault();
                    const { name, description, category } = form;
                    const id = markerIdCounter++;
                    const icon = (categories[category.value] || categories.outro).icon;
                    const popupHTML = getPopupContent(id, name.value, description.value, category.value);
                    const marker = L.marker(e.latlng, {
                        icon, title: name.value, searchableText: `${name.value} ${description.value}`
                    }).bindPopup(popupHTML).bindTooltip(name.value);
                    searchableMarkers.addLayer(marker);
                    markers[id] = { id, marker, name: name.value, description: description.value, lat: e.latlng.lat, lng: e.latlng.lng, category: category.value };
                    saveMarkers();
                    map.closePopup();
                });
                form.querySelector('.cancelBtn').onclick = () => map.closePopup();
            });
        });

        // Editar / apagar ponto
        map.on('popupopen', e => {
            const el = e.popup.getElement();
            const delBtn = el.querySelector('.popup-delete-btn');
            const editBtn = el.querySelector('.popup-edit-btn');

            if (delBtn) {
                delBtn.onclick = () => {
                    const id = Number(delBtn.dataset.id);
                    if (markers[id]) {
                        searchableMarkers.removeLayer(markers[id].marker);
                        map.removeLayer(markers[id].marker);
                        delete markers[id];
                        saveMarkers();
                        map.closePopup();
                    }
                };
            }

            if (editBtn) {
                editBtn.onclick = () => {
                    const id = Number(editBtn.dataset.id);
                    const m = markers[id];
                    map.closePopup();
                    const editPopup = L.popup().setLatLng(m.marker.getLatLng()).setContent(getFormHTML(m)).openOn(map);
                    setTimeout(() => {
                        const form = document.getElementById('editPointForm');
                        form.addEventListener('submit', ev => {
                            ev.preventDefault();
                            const { name, description, category } = form;
                            m.name = name.value;
                            m.description = description.value;
                            m.category = category.value;
                            const newIcon = (categories[m.category] || categories.outro).icon;
                            const popupHTML = getPopupContent(id, m.name, m.description, m.category);
                            m.marker.setIcon(newIcon).setPopupContent(popupHTML).setTooltipContent(m.name);
                            m.marker.options.title = m.name;
                            m.marker.options.searchableText = `${m.name} ${m.description}`;
                            saveMarkers();
                            map.closePopup();
                        });
                        form.querySelector('.cancelBtn').onclick = () => map.closePopup();
                    });
                };
            }
        });

        // Carrega pontos salvos ao iniciar
        loadMarkers();
    </script>
</body>
</html>
